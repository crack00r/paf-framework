name: PAF PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR Title Format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            
            // Valid prefixes
            const validPrefixes = [
              'feat:', 'fix:', 'docs:', 'style:', 'refactor:',
              'perf:', 'test:', 'build:', 'ci:', 'chore:', 'revert:',
              'Fix:', 'Feat:', 'Docs:', 'Chore:',  // Also allow capitalized
              '[SEC-', '[PERF-', '[UX-', '[SCALE-', '[MAINT-',  // Agent prefixes
              '[A11Y-', '[COST-', '[TRIAGE-', '[DOC-', '[IDEA-', '[FIX-'
            ];
            
            const hasValidPrefix = validPrefixes.some(prefix => title.startsWith(prefix));
            
            if (!hasValidPrefix) {
              core.warning(`PR title should start with a conventional commit prefix (e.g., feat:, fix:, docs:) or an agent prefix (e.g., [SEC-001])`);
            }

      - name: Check for Issue Reference
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            
            // Check for issue references
            const hasIssueRef = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#\d+/i.test(body) ||
                               /#\d+/.test(body);
            
            if (!hasIssueRef) {
              core.warning('Consider linking this PR to an issue using "Fixes #123" or mentioning the issue number');
            }

      - name: Add Size Label
        uses: actions/github-script@v7
        with:
          script: |
            const { additions, deletions } = context.payload.pull_request;
            const totalChanges = additions + deletions;
            
            let sizeLabel;
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
            } else if (totalChanges < 200) {
              sizeLabel = 'size/M';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }
            
            // Try to add label (may fail if label doesn't exist)
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [sizeLabel]
              });
            } catch (e) {
              core.info(`Could not add size label: ${e.message}`);
            }

      - name: Welcome First-Time Contributor
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            
            // Check if this is their first PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 2
            });
            
            const creatorPRs = prs.filter(pr => pr.user.login === creator);
            
            if (creatorPRs.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ðŸ‘‹ Welcome @${creator}! Thanks for your first pull request to this project!\n\nA maintainer will review your changes soon.\n\n_Auto-generated by PAF PR Checks_`
              });
            }
