name: PAF Sprint Metrics

on:
  milestone:
    types: [closed]
  workflow_dispatch:
    inputs:
      milestone_number:
        description: 'Milestone number to generate report for'
        required: true
        type: number

permissions:
  issues: write
  contents: read

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Get Milestone Data
        id: milestone
        uses: actions/github-script@v7
        with:
          script: |
            let milestoneNumber;
            
            if (context.eventName === 'workflow_dispatch') {
              milestoneNumber = ${{ inputs.milestone_number || 0 }};
            } else {
              milestoneNumber = context.payload.milestone.number;
            }
            
            const milestone = await github.rest.issues.getMilestone({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone_number: milestoneNumber
            });
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone: milestoneNumber,
              state: 'all',
              per_page: 100
            });
            
            const closedIssues = issues.data.filter(i => i.state === 'closed' && !i.pull_request);
            const openIssues = issues.data.filter(i => i.state === 'open' && !i.pull_request);
            const prs = issues.data.filter(i => i.pull_request);
            
            // Count by label
            const labelCounts = {};
            const priorityCounts = { P0: 0, P1: 0, P2: 0, P3: 0 };
            const agentCounts = {};
            
            closedIssues.forEach(issue => {
              issue.labels.forEach(label => {
                const name = label.name;
                labelCounts[name] = (labelCounts[name] || 0) + 1;
                
                if (['P0', 'P1', 'P2', 'P3'].includes(name)) {
                  priorityCounts[name]++;
                }
                
                if (name.includes('ðŸ”’') || name.includes('âš¡') || name.includes('ðŸŽ¨') ||
                    name.includes('ðŸ”€') || name.includes('ðŸ”§') || name.includes('â™¿') ||
                    name.includes('ðŸ’°') || name.includes('ðŸŽ¯') || name.includes('ðŸ“š') ||
                    name.includes('ðŸ’¡') || name.includes('ðŸ¤–')) {
                  agentCounts[name] = (agentCounts[name] || 0) + 1;
                }
              });
            });
            
            return {
              name: milestone.data.title,
              closed: closedIssues.length,
              open: openIssues.length,
              prs: prs.length,
              priorityCounts,
              agentCounts,
              dueDate: milestone.data.due_on
            };

      - name: Create Sprint Summary Issue
        uses: actions/github-script@v7
        with:
          script: |
            const data = ${{ steps.milestone.outputs.result }};
            
            const agentTable = Object.entries(data.agentCounts)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => `| ${name} | ${count} |`)
              .join('\n');
            
            let body = '# ðŸ“Š Sprint Summary: ' + data.name + '\n\n';
            body += '## Overview\n\n';
            body += '| Metric | Value |\n';
            body += '|--------|-------|\n';
            body += '| âœ… Issues Closed | ' + data.closed + ' |\n';
            body += '| ðŸ“‚ Issues Remaining | ' + data.open + ' |\n';
            body += '| ðŸ”€ PRs Merged | ' + data.prs + ' |\n\n';
            body += '## By Priority\n\n';
            body += '| Priority | Count |\n';
            body += '|----------|-------|\n';
            body += '| ðŸ”´ P0 (Critical) | ' + data.priorityCounts.P0 + ' |\n';
            body += '| ðŸŸ  P1 (High) | ' + data.priorityCounts.P1 + ' |\n';
            body += '| ðŸŸ¡ P2 (Medium) | ' + data.priorityCounts.P2 + ' |\n';
            body += '| ðŸŸ¢ P3 (Low) | ' + data.priorityCounts.P3 + ' |\n\n';
            body += '## By Agent\n\n';
            body += '| Agent | Findings Resolved |\n';
            body += '|-------|-------------------|\n';
            body += (agentTable || '| - | - |') + '\n\n';
            body += '---\n\n';
            body += '_Auto-generated by PAF Sprint Metrics workflow_\n';
            body += '_Generated: ' + new Date().toISOString() + '_\n';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[RETRO] Sprint Summary - ${data.name}`,
              body: body,
              labels: ['retrospective', 'ðŸ“‹ george']
            });
